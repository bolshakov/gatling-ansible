---

- name: Prepare master
  hosts: local
  connection: local
  tasks:
    - include: tasks/prepare_master.yml

- name: Prepare workers
  hosts: workers
  tags:
    - config
  tasks:
    - include: tasks/prepare_worker.yml

- name: Deliver docker contianer
  hosts: workers
  tags:
    - run
  tasks:
    - name: Run Gatling
      docker_container:
        name: gatling-load
        image: docker.spbtv.com/gatling
        state: started
        detach: false # By default this is true
        restart: true
        network_mode: host
        command:
          - --no-reports
          - --simulations-folder /gatling/user-files/simulations
          - --simulation computerdatabase.BasicSimulation
        volumes:
          - /tmp/gatling/results:/gatling/results

    - name: Rename /tmp/gatling/results-{timustamp} to /tmp/gatling/results/results
      shell: ls -t /tmp/gatling/results | head -n 1 | xargs -I {} mv /tmp/gatling/results/{} /tmp/gatling/results/results/
      become: true
    - name: Copy results
      fetch:
        src: /tmp/gatling/results/results/simulation.log
        dest: "./results/simulation-{{ inventory_hostname }}.log"
        flat: true


- name: Generate report
  hosts: local
  connection: local
  tags:
    - report
  tasks:
    - name: Generate report
      docker_container:
        name: gatling-load
        image: docker.spbtv.com/gatling
        state: started
        detach: false # By default this is true
        restart: true
        network_mode: host
        command:
          - --reports-only /gatling/results/
        volumes:
          - '{{ playbook_dir }}/results:/gatling/results'
    - name: Open report
      shell: open ./results/index.html
